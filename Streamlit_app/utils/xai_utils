import os
import json
import numpy as np
import pandas as pd
import joblib
import shap
import matplotlib.pyplot as plt
from tensorflow.keras.models import load_model
from explainability_xai import *
import streamlit as st
# Single-Sample Explainability
def explain_single_anomaly(sample_index, top_n=5, show_figure=True):

    x_sample = validate_and_prepare_input(
        X_test[sample_index:sample_index+1],
        X_train.shape[1]
    )

    iso_shap, ae_shap, pca_shap = get_or_compute_shap(sample_index, x_sample)

    # FIRST compute ensemble
    ensemble_shap, model_contrib = compute_ensemble_shap(
        sample_index,
        iso_shap,
        ae_shap,
        pca_shap
    )

    # THEN rank features
    top_features = rank_top_features(
        ensemble_shap,
        columns_names,
        top_n=top_n
    )

    explanation_text = generate_explanation(top_features)

    waterfall_fig = plot_ensemble_waterfall(
        x_sample,
        ensemble_shap,
        columns_names,
        show_figure=show_figure,
        platform="streamlit"
    )

    return top_features, explanation_text, waterfall_fig, model_contrib